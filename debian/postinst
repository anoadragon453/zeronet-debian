#!/bin/bash

set -e

TRACKER_PORT=6969

pip install msgpack-python --upgrade
if ! id -u "zeronet" >/dev/null 2>&1; then
	useradd -d /opt/zeronet/ -s /bin/false zeronet
fi
chown -R zeronet:zeronet /opt/zeronet

# Hack to ensure that the file access port is opened
# This is because zeronet normally relies on an internet site
# to do this, but on a purely local mesh the internet isn't available
sed -i 's|fileserver_port = 0|fileserver_port = config.fileserver_port\n            sys.modules["main"].file_server.port_opened = True|g' /opt/zeronet/src/Site/Site.py

useradd -d /opt/tracker/ -s /bin/false tracker
if [ ! -d /opt/tracker ]; then
    mkdir /opt/tracker
fi
chown -R tracker:tracker /opt/tracker

systemctl enable tracker.service
systemctl enable zeronet.service

exit 0
